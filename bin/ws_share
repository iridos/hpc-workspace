#!/bin/bash
#
# ws_share is a helper script that can be used to grant quickly read or
# read-write access for a workspace to other users or groups based on UNIX ACLs.

# See ws_share --help to get usage information.
#
# Known issues:
#   Changing file or directory permissions after sharing with the standard UNIX
#   commands chmod, etc. after sharing with another user will not modify the
#   rights appropriately for this user. However, you will likely get a message
#   from these tools, e.g.
#     chmod: ... new permissions are ....., not ....
#   A workaround to update permissions is to unshare and re-share the workspace
#   with the users.
#
# Copyright(c) 2021-2024 Christoph Niethammer <niethammer@hlrs.de>
#

progname=$(basename $0)
maxmembers=100 # do not share with a group with more than $maxmembers members

# Test for compatible getopt version.
# The parser needs an enhanced version of getopt.
# See man page of getopt for this test.
getopt --test
if [[ $? -ne 4 ]]; then
    echo "Error: $progname needs an enhanced getopt to work."
    exit 1
fi

function print_version() {
    # also could call ws_allocate without finding path as running unprivileged
    # but this way more likely we show the correct version
    SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
    "$SCRIPT_DIR"/ws_allocate --version
}

function usage() {
cat <<EOF
$progname allows to share an existing workspace with other users or groups.

usage:

The following commands share / unshare a workspace (WS_NAME) with users:
 $progname [--readwrite] share [-F FILESYSTEM] WS_NAME USER [USER...]
 $progname [--readwrite] unshare [-F FILESYSTEM] WS_NAME USER [USER...]

With groups:
 $progname [--readwrite] sharegroup [-F FILESYSTEM] WS_NAME GROUP [GROUP...]
 $progname [--readwrite] unsharegroup [-F FILESYSTEM] WS_NAME GROUP [GROUP...]

Remove all ACLs from a workspace:
 $progname unshare-all [-F FILESYSTEM] WS_NAME

List users/groups with ACL entries:
 $progname list WS_NAME

options:
   -F, --filesystem  ws filesystem
   -h, --help        show this help
       --version     show version information and exit
       --readwrite   grant read/write instead of read-only access

EOF
}


# parse command line, based on example provided by util-linux
OPTIONS=F:h
LONG_OPTIONS=filesystem:,help,version,readwrite
PARSED=$(getopt --options=$OPTIONS --longoptions=$LONG_OPTIONS --name "$0" -- "$@")
if [[ $? -ne 0 ]]; then
    echo "Error: Command line error"
    usage
    exit 1
fi
eval set -- "$PARSED"
unset PARSED

ACCESS="rX"  # default: read-only
# parse options
while true; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -F|--filesystem)
            FILESYSTEM="$2"
            shift 2
            ;;
        --version)
            print_version
            exit 0
            ;;
        --readwrite)
            ACCESS="rwX"
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "Error: Found unknown option"
            usage
            exit 1
            ;;
    esac
done

ACTION="$1"
shift
WS_NAME="$1"
shift

if [[ -z "$ACTION" ]]; then
    echo "Error: no action specified"
    exit 1
fi
if [[ -z "$WS_NAME" ]]; then
    echo "Error: workspace name missing"
    exit 1
fi
WS_PATH=$(ws_find ${FILESYSTEM:+-F $FILESYSTEM} $WS_NAME)
if [[ $? -ne 0 || -z "$WS_PATH" ]]; then
    echo "Error: Invalid workspace name."
    exit 1
fi

case $ACTION in
    list)
        getfacl -apt "$WS_PATH" | awk '/user|group|USER|GROUP/&&!/---/{gsub("rw.","readwrite");gsub("r-.","read");print}'
        ;;
    share)
        USERS="$@"
        MACL=""
        for user in $USERS; do
            if ! id "$user" >/dev/null 2>&1; then
                echo "Error: User $user unknown"
                exit 1
            fi
            echo "Granting $ACCESS access for user $user ..."
            MACL+="user:$user:$ACCESS,"
            MACL+="default:user:$user:$ACCESS,"
        done
        if [[ -z "$MACL" ]]; then
            # nothing to do
            exit 0
        fi
        setfacl -R -m "$MACL" "$WS_PATH"
        ;;
    unshare)
        USERS="$@"
        XACL=""
        for user in $USERS; do
            if ! id "$user" >/dev/null 2>&1; then
                echo "Error: User $user unknown"
                exit 1
            fi
            echo "Removing access for $user"
            XACL+="user:$user,"
            XACL+="default:user:$user,"
        done
        if [[ -z "$XACL" ]]; then
            exit 0
        fi
        setfacl -R -x "$XACL" "$WS_PATH"
        ;;
    sharegroup)
        GROUPS="$@"
        MACL=""
        for group in $GROUPS; do
            line=$(getent group "$group")
            if [[ -z "$line" ]]; then
                echo "Error: Group $group unknown"
                exit 1
            fi
            if [[ $(echo "$line" | awk -F "," '{print NF-1}') -gt $maxmembers ]] ; then 
                echo Too many members in group, please do not share worldwide ; 
                exit 1; 
            fi
            echo "Granting $ACCESS access for group $group ..."
            MACL+="group:$group:$ACCESS,"
            MACL+="default:group:$group:$ACCESS,"
        done
        if [[ -n "$MACL" ]]; then
          if [[ ACCESS == "rwX" ]] ; then
              echo "Warning: giving write access to your group may:"
              echo "  * immediate workspace deletion"
              echo "  * interfere with your quota (depending on system setup)"
              read -p "Continue (y/N)? " answer
                 case "$answer" in
                    [yY]*) ;;
                    *) echo "Aborted."; exit 1 ;;
                 esac
          setfacl -R -m "$MACL" "$WS_PATH"
        fi
        ;;
    unsharegroup)
        GROUPS="$@"
        XACL=""
        for group in $GROUPS; do
            if ! getent group "$group" >/dev/null; then
                echo "Error: Group $group unknown"
                exit 1
            fi
            echo "Removing access for group $group"
            echo "Warning: will produce errors on files not owned by you"
            sleep 3;
            XACL+="group:$group,"
            XACL+="default:group:$group,"
        done
        [[ -n "$XACL" ]] && setfacl -R -x "$XACL" "$WS_PATH"
        ;;
    unshare-all)
        echo "Warning: will produce errors on files not owned by you"
        sleep 3;
        setfacl -R -b "$WS_PATH"
        ;;
    check)
        ;;
    *)
        echo "Error: Invalid action $ACTION"
        usage
        exit 1
esac

